<!DOCTYPE html>
<html>
<head>

    <title>Capture Screen with Rectangle</title>
    <script src="webgazer.js" type="text/javascript" ></script>
    
    <script>
        webgazer.begin();
        let captureInterval;

        async function startCapture() {
            try {
                // 디스플레이(스크린)에서 미디어(영상) 스트림을 비동기적으로 가져오는 JavaScript의 명령입니다
                const mediaStream = await navigator.mediaDevices.getDisplayMedia({ video: true });    

                // 5초마다 캡처
                captureInterval = setInterval(() => {
                    captureFrame(mediaStream);
                }, 5000);
            } catch(err) {
                console.error("Error: " + err);
            }
        }

        function stopCapture() {
            clearInterval(captureInterval);

            let tracks = videoElem.srcObject.getTracks();
            tracks.forEach(track => track.stop());
            videoElem.srcObject = null;
        }

        async function captureFrame(mediaStream) {
            var startX = 0; // 시작점 x좌표
            var startY = 0; // 시작점 y좌표
            const width = 300; // 가로 길이
            const height = 200; // 세로 길이

            await webgazer.getCurrentPrediction().then(prediction => {
	            if (prediction) {
	                startX = prediction.x;
	                startY = prediction.y;
	                console.log(`여기서 안 바뀜? - X: ${startX}, Y: ${startY}`);
	            }
		    });


            // 화면 들고오기
            const videoTrack = mediaStream.getVideoTracks()[0];
            console.log(`Current Prediction - X: ${startX}, Y: ${startY}`);
            // videoTrack을 이용하여 ImageCapture 객체를 생성합니다. ImageCapture는 비디오 트랙에서 이미지를 캡처할 수 있는 API입니다.
            const imageCapture = new ImageCapture(videoTrack);
            
            // 좌표 설정 (시작점과 가로, 세로 길이)
            

            // grabFrame 메소드를 호출하여 현재 비디오 트랙에서 프레임을 캡처합니다. 이 메소드는 Promise를 반환하며,
            // 성공 시 imageBitmap 객체를 반환합니다.
            imageCapture.grabFrame()
                .then(imageBitmap => {
                    // canvas 요소를 동적으로 생성하고, 캡처한 이미지의 크기에 맞게 크기를 설정합니다.
                    // canvas의 2D 렌더링 컨텍스트를 가져와서 imageBitmap을 그립니다.
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const context = canvas.getContext('2d');
                    context.drawImage(imageBitmap, startX, startY, width, height, 0, 0, width, height);

                    // canvas.toBlob 메소드를 사용하여 캔버스의 내용을 블롭(Blob)으로 변환합니다.
                    // 블롭을 가리키는 URL을 생성하고, 이를 a 태그의 href 속성에 할당합니다.
                    // 다운로드 속성을 설정하여 파일 이름을 'screenshot.png'로 지정하고, a 태그를 클릭하여 파일을 다운로드합니다.
                    canvas.toBlob(blob => {
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'screenshot.png';
                        a.click();
                        URL.revokeObjectURL(url);
                    });
                })
                .catch(error => console.error("Frame capture error:", error));
        }
    </script>
</head>
<body style="text-align: center;">
    <button onclick="startCapture()">Start Capture</button>
    <button onclick="stopCapture()">Stop Capture</button>
</body>
</html>
